---
- name: Install PostgreSQL
  apt: pkg={{ item }} state=present
  with_items:
    - postgresql
    - libpq-dev
    - python-psycopg2

- name: "Look up PostgreSQL version"
  shell: psql --version | grep -Po '(?<=\(PostgreSQL\)\s)\d\.\d'
  register: "postgresql_version"

- name: "Configure access control"
  template:
    src: "pg_hba.conf"
    dest: "/etc/postgresql/{{ postgresql_version.stdout }}/main/pg_hba.conf"
  notify: "postgresql_restart"

- name: "Configure network listener"
  lineinfile:
    path: "/etc/postgresql/{{ postgresql_version.stdout }}/main/postgresql.conf"
    regexp: "listen_addresses"
    line: "listen_addresses = '{{ postgresql_listen_addresses }}'     # what IP address(es) to listen on;"
  when: postgresql_listen_addresses is defined
  notify: "postgresql_restart"

- name: "Configure the firewall (postgres)"
  ufw: rule=allow port=postgres
  when: postgresql_listen_addresses is defined and postgresql_listen_addresses != 'localhost'

- name: Ensure Super User Account
  become: yes
  become_user: postgres
  postgresql_user: name={{ ansible_user|default(lookup('env', 'USER'), True) }}
                   state=present
                   role_attr_flags=LOGIN,SUPERUSER

- name: Create database for Super User account
  become: yes
  become_user: postgres
  postgresql_db: name={{ ansible_user|default(lookup('env', 'USER'), True) }}
                 state=present
                 owner={{ ansible_user|default(lookup('env', 'USER'), True) }}
...
